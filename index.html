<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Healthcare Finder</title>

  <!-- Leaflet (free map library) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 2rem auto;
      line-height: 1.5;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    select {
      margin-top: 0.25rem;
      padding: 0.25rem;
    }
    button {
      margin-top: 1.5rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    .results {
      margin-top: 2rem;
      border-top: 1px solid #ccc;
      padding-top: 1.5rem;
    }
    .service {
      margin-bottom: 1rem;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fff;
    }
    .service h3 {
      margin: 0 0 0.25rem 0;
    }
    .service p {
      margin: 0.25rem 0;
    }
    input[type="checkbox"] {
      margin-right: 0.5rem;
    }
    .helper {
      margin-top: 0.5rem;
      font-size: 0.95rem;
      color: #555;
    }
    .muted {
      color: #555;
    }
    .two-col {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    .clickable {
      cursor: pointer;
    }
    .clickable:hover {
      border-color: #bbb;
    }
    #map-wrapper {
      display: none; /* only show after results */
      margin-top: 1rem;
    }
    #service-map {
      height: 380px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
  </style>
</head>

<body>
  <h1>Find Healthcare Resources</h1>

  <form id="healthcare-form">
    <label for="residency">What is your residency status?</label>
    <select name="residency" id="residency">
      <option value="local">Domestic (In Province)</option>
      <option value="out">Domestic (Out of Province)</option>
      <option value="international">International</option>
    </select>

    <label>What health insurance coverage do you have? (Select all that apply)</label>

    <label>
      <input type="checkbox" name="insurance" value="ramq" />
      Quebec provincial insurance (RAMQ)
    </label>

    <label>
      <input type="checkbox" name="insurance" value="other_prov" />
      Other provincial/territorial health insurance (For Canadian residents from outside Quebec)
    </label>

    <label>
      <input type="checkbox" name="insurance" value="bluecross" />
      Blue Cross (International students)
    </label>

    <label>
      <input type="checkbox" name="insurance" value="ssmu" />
      Undergraduate Supplemental Insurance Plan (SSMU or MCSS)
    </label>

    <label>
      <input type="checkbox" name="insurance" value="none" />
      None / Not sure
    </label>

    <p class="helper">
      To know if you are enrolled in the SSMU or MCSS plan at McGill, check your tuition invoice on Minerva for a
      "Student Association Health/Dental" fee. Undergraduate students paying Quebec/Canadian tuition rates in the Fall semester are automatically enrolled.
    </p>

    <label for="need">What kind of healthcare do you need?</label>
    <select name="need" id="need">
      <option value="general">General Health</option>
      <option value="mental">Mental Health</option>
      <option value="sexual">Sexual Health</option>
      <option value="urgent">Emergency Care</option>
    </select>

    <div id="problem-wrapper" style="display:none;">
      <label for="problem">What best describes your situation?</label>
      <select id="problem"></select>
    </div>
    

    <button type="submit">Find Resources</button>
  </form>

  <!-- Where results will appear -->
  <div id="results" class="results"></div>

  <!-- Map + details (hidden until results appear) -->
  <div id="map-wrapper">
    <h2>Nearby Locations Map</h2>
    <p class="muted">Click a pin or a location card to see details and cost/coverage notes.</p>

    <div id="service-map"></div>

    <div id="location-details" class="service" style="display:none; margin-top: 1rem;"></div>
  </div>

  <script>
    /***********************
     * 0) DATA (EDIT LATER)
     ***********************/

   // Problem categories shown after selecting a need.
// For now we only add sub-categories for "general".
const problemOptions = {
  general: [
    { value: "minor_illness", label: "Minor illness (cold, flu, sore throat, fever)" },
    { value: "physical_injury", label: "Physical injury (sprain, strain, minor fracture)" },
    { value: "ongoing_pain", label: "Ongoing pain (headache, back pain, joint pain)" },
    { value: "skin", label: "Skin concerns (rash, acne, infection)" },
    { value: "digestive", label: "Stomach or digestive issues" },
    { value: "medication", label: "Medication questions or refills" },
    { value: "chronic", label: "Chronic condition management (asthma, diabetes, etc.)" },
    { value: "forms", label: "Medical forms or doctor’s note" },
    { value: "other", label: "Not sure / something else" }
  ]
};
  
    // Center point (McGill downtown campus-ish)
    const MCGILL_CENTER = {
      name: "McGill University (Downtown Campus)",
      lat: 45.5048,
      lng: -73.5772
    };

    // "Resources" are informational (may not have a map pin).
    // "Locations" are physical places; we will map them.
    //
    // NOTE: Some clinics below are included as *fillers* and can be replaced later.
    // For any location without lat/lng, the code will try to geocode the address automatically.
    const resources = [
      {
        id: "info-sante-811",
        name: "Info-Santé 811",
        url: "https://www.quebec.ca/en/health/finding-a-resource/info-sante-811",
        needs: ["urgent", "general", "mental", "sexual"],
        description: "Free phone line to connect with a nurse for non-urgent health advice (24/7)."
      }
      
    ];

    // Physical locations to show on the map + list.
    const locations = [
      // ER / Emergency departments
      {
        id: "mgh-er",
        name: "Montreal General Hospital (MUHC) – Emergency",
        needs: ["urgent"],
        address: "1650 Cedar Ave, Montréal, QC H3G 1A4",
        url: "https://muhc.ca/montreal-general-hospital",
        tags: ["Emergency room"]
      },
      {
        id: "chum-er",
        name: "CHUM – Emergency",
        needs: ["urgent"],
        address: "1001 Rue Sanguinet, Montréal, QC H2X 1R6",
        url: "https://www.chumontreal.qc.ca/le-chum-votre-hopital/nous-joindre",
        tags: ["Emergency room"]
      },
      {
        id: "jgh-er",
        name: "Jewish General Hospital – Emergency",
        needs: ["urgent"],
        address: "3755 Chemin de la Côte-Sainte-Catherine, Montréal, QC H3T 1E2",
        url: "https://www.jgh.ca/care-services/emergency/",
        tags: ["Emergency room"]
      },

      // General / walk-in style clinics (fillers you can replace)
      {
        id: "mcgill-wellness-hub",
        name: "McGill Student Wellness Hub",
        url: "https://www.mcgill.ca/wellness-hub/",
        needs: ["general", "mental", "sexual"],
        problems: ["minor_illness", "physical_injury", "ongoing_pain", "skin", "digestive", "medication", "forms", "other"],
        description: "Starting point for many McGill student health and wellness services."
      },
      {
        id: "centre-medical-decelles",
        name: "Centre Médicale Décelles (Example clinic)",
        needs: ["general"],
        problems: ["minor_illness", "physical_injury", "ongoing_pain", "skin", "digestive", "medication", "forms", "other"],
        address: "6900 Ave Decarie, Montréal, QC",
        url: "https://www.mcgill.ca/wellness-hub/get-support/physical-health/appointment",
        tags: ["Example clinic", "Appointments / walk-in may vary"]
      },
      {
        id: "cura-sante",
        name: "Cura Santé (Example clinic)",
        needs: ["general"],
        problems: ["minor_illness", "physical_injury", "ongoing_pain", "skin", "digestive", "medication", "forms", "other"],
        address: "5515 Rue Saint-Jacques, Montréal, QC",
        url: "https://www.mcgill.ca/wellness-hub/get-support/physical-health/appointment",
        tags: ["Example clinic", "Appointments / walk-in may vary"]
      },

      // Sexual health (placeholder)
      {
        id: "sexual-health-placeholder",
        name: "Sexual Health Clinic (Placeholder)",
        needs: ["sexual"],
        address: "Montréal, QC (replace with your preferred clinic/CLSC)",
        url: "",
        tags: ["Placeholder"]
      },

      // Mental health (placeholder physical location)
      {
        id: "mental-health-placeholder",
        name: "Mental Health Clinic/Center (Placeholder)",
        needs: ["mental"],
        address: "Montréal, QC (replace with your preferred center)",
        url: "",
        tags: ["Placeholder"]
      }
    ];

    /*************************************
     * 1) COVERAGE TEXT (YOUR EXISTING LOGIC)
     *************************************/
    function getCoverageText({ residency, insurance }) {
      const lines = [];

      // Residency-based note
      if (residency === "local") {
        lines.push("As an in-province student, RAMQ generally covers medically necessary services in Quebec.");
      } else if (residency === "out") {
        lines.push("As an out-of-province student, your home provincial plan may cover some services in Quebec; check out-of-province rules.");
      } else if (residency === "international") {
        lines.push("As an international student, you may have coverage through Blue Cross (if enrolled).");
      }

      // Insurance-based notes (multiple selections)
      if (insurance.length === 0 || insurance.includes("none")) {
        lines.push("You selected none / not sure. If you're unsure about your coverage, check Minerva/your tuition invoice or contact student services.");
        return lines.join(" ");
      }

      if (insurance.includes("ramq")) {
        lines.push("You selected Quebec provincial insurance (RAMQ). Many doctor and hospital services in Quebec are covered.");
      }
      if (insurance.includes("other_prov")) {
        lines.push("You selected other provincial/territorial insurance. Your home province may cover some services in Quebec; reimbursement rules vary.");
      }
      if (insurance.includes("bluecross")) {
        lines.push("You selected Blue Cross (international students). Check covered services, clinics, and claim procedures through your plan.");
      }
      if (insurance.includes("ssmu")) {
        lines.push("You selected the Undergraduate Supplemental Insurance Plan (SSMU/MCSS). This often helps cover prescriptions, mental health services, and other costs not fully covered by provincial insurance.");
      }

      return lines.join(" ");
    }

    /****************************************************
     * 2) MAKE "NONE / NOT SURE" MUTUALLY EXCLUSIVE
     ****************************************************/
    document.querySelectorAll('input[name="insurance"]').forEach((box) => {
      box.addEventListener("change", () => {
        const noneBox = document.querySelector('input[name="insurance"][value="none"]');
        const checkedBoxes = Array.from(document.querySelectorAll('input[name="insurance"]:checked'));

        if (box.value === "none" && box.checked) {
          checkedBoxes.forEach((cb) => {
            if (cb.value !== "none") cb.checked = false;
          });
        } else if (checkedBoxes.some((cb) => cb.value !== "none")) {
          noneBox.checked = false;
        }
      });
    });

    /*************************************
     * 3) MAP + CLICKABLE DETAILS
     *************************************/
    let serviceMap = null;
    let serviceMarkers = [];
    const geocodeCache = new Map(); // address -> {lat, lng}

    function showMapUI() {
      document.getElementById("map-wrapper").style.display = "block";
    }

    function hideMapUI() {
      document.getElementById("map-wrapper").style.display = "none";
      document.getElementById("location-details").style.display = "none";
    }

    function initServiceMap() {
      if (serviceMap) return;

      serviceMap = L.map("service-map").setView([MCGILL_CENTER.lat, MCGILL_CENTER.lng], 13);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(serviceMap);

      // McGill marker (always)
      const mcgillMarker = L.marker([MCGILL_CENTER.lat, MCGILL_CENTER.lng]).addTo(serviceMap);
      mcgillMarker.bindPopup(`<b>${MCGILL_CENTER.name}</b>`);
    }

    function clearMarkers() {
      serviceMarkers.forEach(m => m.remove());
      serviceMarkers = [];
    }

    async function geocodeAddress(address) {
      if (!address) return null;
      if (geocodeCache.has(address)) return geocodeCache.get(address);

      // Uses OpenStreetMap Nominatim (no API key).
      // If it fails, we just won't place that pin.
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;

      try {
        const resp = await fetch(url, {
          headers: {
            "Accept": "application/json"
          }
        });
        const data = await resp.json();

        if (!Array.isArray(data) || data.length === 0) return null;

        const result = {
          lat: Number(data[0].lat),
          lng: Number(data[0].lon)
        };
        if (Number.isFinite(result.lat) && Number.isFinite(result.lng)) {
          geocodeCache.set(address, result);
          return result;
        }
        return null;
      } catch (e) {
        return null;
      }
    }

    function getDirectionsUrl(lat, lng) {
      return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(lat + "," + lng)}`;
    }

    function buildLocationCoverageText(location, userSelections) {
      // Simple per-location logic for now (you can customize later per clinic).
      // You can make this as detailed as you want by adding a "coverageRules" field per location.
      const base = getCoverageText(userSelections);

      const extras = [];
      if (location.needs.includes("urgent")) {
        extras.push("Emergency departments generally provide care regardless of ability to pay up front, but billing and eligibility can vary—especially for non-RAMQ coverage.");
      } else {
        extras.push("Costs can vary by clinic and service type. Call ahead if you're unsure about fees or what insurance they accept.");
      }

      return `${base} ${extras.join(" ")}`;
    }

    function showLocationDetails(location, userSelections, resolvedLatLng) {
      const details = document.getElementById("location-details");
      details.style.display = "block";

      const coverageText = buildLocationCoverageText(location, userSelections);

      const lat = resolvedLatLng?.lat;
      const lng = resolvedLatLng?.lng;
      const directions = (lat && lng) ? getDirectionsUrl(lat, lng) : null;

      const tagsHtml = (location.tags && location.tags.length)
        ? `<p class="muted"><strong>Tags:</strong> ${location.tags.join(", ")}</p>`
        : "";

      details.innerHTML = `
        <h3>${location.name}</h3>
        ${location.address ? `<p><strong>Address:</strong> ${location.address}</p>` : ""}
        ${tagsHtml}
        ${location.url ? `<p><a href="${location.url}" target="_blank" rel="noopener noreferrer">Website</a></p>` : ""}
        ${directions ? `<p><a href="${directions}" target="_blank" rel="noopener noreferrer">Get directions</a></p>` : ""}
        <p><strong>Cost / coverage notes:</strong> ${coverageText}</p>
      `;
    }

    async function renderLocationsOnMap(matchingLocations, userSelections) {
      initServiceMap();
      clearMarkers();

      // Resolve coordinates (lat/lng) for each location
      const resolved = [];
      for (const loc of matchingLocations) {
        // If you later add exact lat/lng, they will be used automatically.
        let latLng = null;
        if (typeof loc.lat === "number" && typeof loc.lng === "number") {
          latLng = { lat: loc.lat, lng: loc.lng };
        } else {
          latLng = await geocodeAddress(loc.address);
        }
        resolved.push({ loc, latLng });
      }

      // Add markers for locations with coordinates
      const boundsPoints = [[MCGILL_CENTER.lat, MCGILL_CENTER.lng]];
      for (const item of resolved) {
        if (!item.latLng) continue;

        boundsPoints.push([item.latLng.lat, item.latLng.lng]);

        const marker = L.marker([item.latLng.lat, item.latLng.lng]).addTo(serviceMap);
        marker.bindPopup(`<b>${item.loc.name}</b><br/><span class="muted">Click for details</span>`);
        marker.on("click", () => {
          showLocationDetails(item.loc, userSelections, item.latLng);
          serviceMap.setView([item.latLng.lat, item.latLng.lng], 14);
        });

        serviceMarkers.push(marker);
      }

      // Fit map to show everything we can
      if (boundsPoints.length > 1) {
        serviceMap.fitBounds(boundsPoints, { padding: [30, 30] });
      } else {
        serviceMap.setView([MCGILL_CENTER.lat, MCGILL_CENTER.lng], 13);
      }

      return resolved;
    }

    /*************************************
     * 4) FORM SUBMIT: SHOW RESULTS + MAP
     *************************************/
    const form = document.getElementById("healthcare-form");
    const resultsDiv = document.getElementById("results");

  // Show/hide the problem dropdown when "need" changes
const needSelect = document.getElementById("need");
const problemWrapper = document.getElementById("problem-wrapper");
const problemSelect = document.getElementById("problem");

function updateProblemDropdown() {
  const need = needSelect.value;

  if (problemOptions[need]) {
    problemWrapper.style.display = "block";
    problemSelect.innerHTML = "";

    problemOptions[need].forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.value;
      opt.textContent = p.label;
      problemSelect.appendChild(opt);
    });
  } else {
    problemWrapper.style.display = "none";
    problemSelect.innerHTML = "";
  }
}

// Run once on load + when need changes
updateProblemDropdown();
needSelect.addEventListener("change", updateProblemDropdown);
  
    form.addEventListener("submit", async function (event) {
      event.preventDefault();

      const residency = document.getElementById("residency").value;
      const need = document.getElementById("need").value;
      const problem = (problemWrapper.style.display !== "none") ? problemSelect.value : "";

      const insurance = Array.from(
        document.querySelectorAll('input[name="insurance"]:checked')
      ).map((cb) => cb.value);

      const userSelections = { residency, insurance };

      // 1) Coverage notes (general)
      const coverageText = getCoverageText(userSelections);

      // 2) Filter resources + locations for selected need
      const matchingResources = resources.filter(r => r.needs.includes(need));
      const matchingLocations = locations.filter(l => {
  if (!l.needs.includes(need)) return false;

  // Only apply "problem" filtering for general health
  if (need === "general") {
    if (!problem) return true;           // no problem selected (shouldn't happen often)
    if (!l.problems) return true;        // if clinic doesn't specify problems yet, still include it
    return l.problems.includes(problem); // otherwise match the selected problem
  }

  return true;
});

      // 3) Build results HTML (resources + clickable location cards)
      const needLabel = document.getElementById("need").options[document.getElementById("need").selectedIndex].text;

      let html = `<h2>Recommended Services for: ${needLabel}</h2>`;
      html += `<p><strong>Coverage notes:</strong> ${coverageText}</p>`;

      if (need === "general" && problem) {
      const problemLabel = problemSelect.options[problemSelect.selectedIndex]?.text || "";
        html += `<p><strong>Selected category:</strong> ${problemLabel}</p>`;
      }

      if (need === "urgent") {
        html += `
          <div class="service">
            <h3>Emergency note</h3>
            <p>If you are in immediate danger or experiencing a medical emergency, call 911 or go to the nearest emergency department.</p>
          </div>
        `;
      }

      // Resources section
      if (matchingResources.length) {
        html += `<h3>Resources</h3>`;
        matchingResources.forEach((r) => {
          html += `
            <div class="service">
              <h3>${r.name}</h3>
              <p>${r.description || ""}</p>
              ${r.url ? `<p><a href="${r.url}" target="_blank" rel="noopener noreferrer">Learn more</a></p>` : ""}
            </div>
          `;
        });
      }

      // Locations section
      html += `<h3>Locations</h3>`;
      if (!matchingLocations.length) {
        html += `<p>No locations found for that selection.</p>`;
        resultsDiv.innerHTML = html;

        // Hide map if nothing to show
        hideMapUI();
        return;
      }

      // Show loading message while we geocode + render map
      resultsDiv.innerHTML = html + `<p class="muted">Loading map and locations…</p>`;
      showMapUI();
      initServiceMap();

      // Render markers and get resolved lat/lng
      const resolved = await renderLocationsOnMap(matchingLocations, userSelections);

      // Now render clickable location cards
      let locationsHtml = "";
      resolved.forEach(({ loc, latLng }) => {
        const hasCoords = !!latLng;
        const coordsNote = hasCoords ? "" : `<p class="muted"><em>(Pin not available yet — update the address or add coordinates.)</em></p>`;

        locationsHtml += `
          <div class="service clickable" data-loc-id="${loc.id}">
            <h3>${loc.name}</h3>
            <p>${loc.address || ""}</p>
            ${coordsNote}
            <p class="muted"><em>Click for details, costs, and coverage notes.</em></p>
          </div>
        `;
      });

      resultsDiv.innerHTML = html + locationsHtml;

      // Add click handlers for each card
      document.querySelectorAll('[data-loc-id]').forEach(card => {
        card.addEventListener("click", () => {
          const id = card.getAttribute("data-loc-id");
          const item = resolved.find(x => x.loc.id === id);
          if (!item) return;

          showLocationDetails(item.loc, userSelections, item.latLng);

          if (item.latLng) {
            serviceMap.setView([item.latLng.lat, item.latLng.lng], 14);
          }
        });
      });
    });
  </script>
</body>
</html>
