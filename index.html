<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Healthcare Finder</title>

  <!-- Leaflet (free map library) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 2rem auto;
      line-height: 1.5;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    select {
      margin-top: 0.25rem;
      padding: 0.25rem;
    }
    button {
      margin-top: 1.5rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    .results {
      margin-top: 2rem;
      border-top: 1px solid #ccc;
      padding-top: 1.5rem;
    }
    .card {
      margin-bottom: 1rem;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fff;
    }
    .card h3 {
      margin: 0 0 0.25rem 0;
    }
    .card p {
      margin: 0.25rem 0;
    }
    input[type="checkbox"] {
      margin-right: 0.5rem;
    }
    .helper {
      margin-top: 0.5rem;
      font-size: 0.95rem;
      color: #555;
    }
    .muted {
      color: #555;
    }
    .clickable {
      cursor: pointer;
    }
    .clickable:hover {
      border-color: #bbb;
    }

    /* Map */
    #map-wrapper {
      display: none; /* only show after results */
      margin-top: 1rem;
    }
    #service-map {
      height: 380px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    /* “Pages” (views) */
    #search-view { display: block; }
    #details-view { display: none; }

    .topbar {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .back-btn {
      padding: 0.4rem 0.75rem;
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 6px;
      cursor: pointer;
    }
    .back-btn:hover {
      border-color: #bbb;
    }
  </style>
</head>

<body>

  <!-- =========================
       VIEW 1: SEARCH + RESULTS
       ========================= -->
  <div id="search-view">
    <h1>Find Healthcare Resources</h1>

    <form id="healthcare-form">
      <label for="residency">What is your residency status?</label>
      <select name="residency" id="residency">
        <option value="local">Domestic (In Province)</option>
        <option value="out">Domestic (Out of Province)</option>
        <option value="international">International</option>
      </select>

      <label>What health insurance coverage do you have? (Select all that apply)</label>

      <label><input type="checkbox" name="insurance" value="ramq" />Quebec provincial insurance (RAMQ)</label>
      <label><input type="checkbox" name="insurance" value="other_prov" />Other provincial/territorial health insurance (For Canadian residents from outside Quebec)</label>
      <label><input type="checkbox" name="insurance" value="bluecross" />Blue Cross (International students)</label>
      <label><input type="checkbox" name="insurance" value="ssmu" />Undergraduate Supplemental Insurance Plan (SSMU or MCSS)</label>
      <label><input type="checkbox" name="insurance" value="none" />None / Not sure</label>

      <p class="helper">
        To know if you are enrolled in the SSMU or MCSS plan at McGill, check your tuition invoice on Minerva for a
        "Student Association Health/Dental" fee. Undergraduate students paying Quebec/Canadian tuition rates in the Fall semester are automatically enrolled.
      </p>

      <label for="need">What kind of healthcare do you need?</label>
      <select name="need" id="need">
        <option value="general">General Health</option>
        <option value="mental">Mental Health</option>
        <option value="sexual">Sexual Health</option>
        <option value="urgent">Emergency Care</option>
      </select>

      <!-- Hidden until "General Health" is selected -->
      <div id="problem-wrapper" style="display:none;">
        <label for="problem">What best describes your situation?</label>
        <select id="problem"></select>
      </div>

      <button type="submit">Find Resources</button>
    </form>

    <div id="results" class="results"></div>

    <!-- Map (hidden until results appear) -->
    <div id="map-wrapper">
      <h2>Nearby Locations Map</h2>
      <p class="muted">Click a pin or a location card to see details.</p>
      <div id="service-map"></div>
    </div>
  </div>

  <!-- =========================
       VIEW 2: DETAILS “PAGE”
       ========================= -->
  <div id="details-view">
    <div class="topbar">
      <button class="back-btn" id="back-btn">← Back to results</button>
      <div class="muted" id="details-breadcrumb"></div>
    </div>

    <div id="details-card" class="card"></div>
  </div>

  <script>
    /***********************
     * 0) DATA (EDIT LATER)
     ***********************/
    const problemOptions = {
      general: [
        { value: "minor_illness", label: "Minor illness (cold, flu, sore throat, fever)" },
        { value: "physical_injury", label: "Physical injury (sprain, strain, minor fracture)" },
        { value: "ongoing_pain", label: "Ongoing pain (headache, back pain, joint pain)" },
        { value: "skin", label: "Skin concerns (rash, acne, infection)" },
        { value: "digestive", label: "Stomach or digestive issues" },
        { value: "medication", label: "Medication questions or refills" },
        { value: "chronic", label: "Chronic condition management (asthma, diabetes, etc.)" },
        { value: "forms", label: "Medical forms or doctor’s note" },
        { value: "other", label: "Not sure / something else" }
      ]
    };

    const MCGILL_CENTER = {
      name: "McGill University (Downtown Campus)",
      lat: 45.5048,
      lng: -73.5772
    };

    // Resources = informational, not mapped
    const resources = [
      {
        id: "info-sante-811",
        name: "Info-Santé 811",
        url: "https://www.quebec.ca/en/health/finding-a-resource/info-sante-811",
        needs: ["urgent", "general", "mental", "sexual"],
        description: "Free phone line to connect with a nurse for non-urgent health advice (24/7)."
      },
      {
        id: "mcgill-wellness-hub-resource",
        name: "McGill Student Wellness Hub",
        url: "https://www.mcgill.ca/wellness-hub/",
        needs: ["general", "mental", "sexual"],
        description: "Starting point for many McGill student health and wellness services."
      }
    ];

    // Locations = physical places, mapped
    const locations = [
      {
        id: "mgh-er",
        name: "Montreal General Hospital (MUHC) – Emergency",
        needs: ["urgent"],
        address: "1650 Cedar Ave, Montréal, QC H3G 1A4",
        url: "https://muhc.ca/montreal-general-hospital",
        servicesOffered: ["Emergency assessment", "Urgent imaging/referrals", "Hospital-based emergency care"],
        tags: ["Emergency room"]
      },
      {
        id: "chum-er",
        name: "CHUM – Emergency",
        needs: ["urgent"],
        address: "1001 Rue Sanguinet, Montréal, QC H2X 1R6",
        url: "https://www.chumontreal.qc.ca/le-chum-votre-hopital/nous-joindre",
        servicesOffered: ["Emergency assessment", "Hospital-based emergency care"],
        tags: ["Emergency room"]
      },
      {
        id: "jgh-er",
        name: "Jewish General Hospital – Emergency",
        needs: ["urgent"],
        address: "3755 Chemin de la Côte-Sainte-Catherine, Montréal, QC H3T 1E2",
        url: "https://www.jgh.ca/care-services/emergency/",
        servicesOffered: ["Emergency assessment", "Hospital-based emergency care"],
        tags: ["Emergency room"]
      },

      {
        id: "mcgill-wellness-hub",
        name: "McGill Student Wellness Hub",
        needs: ["general", "mental", "sexual"],
        problems: ["minor_illness", "physical_injury", "ongoing_pain", "skin", "digestive", "medication", "chronic", "forms", "other"],
        address: "McGill Downtown Campus, Montréal, QC",
        url: "https://www.mcgill.ca/wellness-hub/",
        servicesOffered: [
          "Appointments/referrals (depending on service)",
          "Navigation to McGill health services",
          "Wellness and mental health supports"
        ],
        tags: ["Student services"]
      },
      {
        id: "centre-medical-decelles",
        name: "Centre Médicale Décelles (Example clinic)",
        needs: ["general"],
        problems: ["minor_illness", "physical_injury", "ongoing_pain", "skin", "digestive", "medication", "chronic", "forms", "other"],
        address: "6900 Ave Decarie, Montréal, QC",
        url: "https://www.mcgill.ca/wellness-hub/get-support/physical-health/appointment",
        servicesOffered: [
          "General medical appointments",
          "Illness/injury assessment (non-emergency)",
          "Basic prescriptions/refills (varies)"
        ],
        tags: ["Example clinic", "Appointments / walk-in may vary"]
      },
      {
        id: "cura-sante",
        name: "Cura Santé (Example clinic)",
        needs: ["general"],
        problems: ["minor_illness", "physical_injury", "ongoing_pain", "skin", "digestive", "medication", "chronic", "forms", "other"],
        address: "5515 Rue Saint-Jacques, Montréal, QC",
        url: "https://www.mcgill.ca/wellness-hub/get-support/physical-health/appointment",
        servicesOffered: [
          "General medical appointments",
          "Illness assessment",
          "Referrals (varies by clinic)"
        ],
        tags: ["Example clinic", "Appointments / walk-in may vary"]
      }
    ];

    /*************************************
     * 1) COVERAGE / COST TEXT
     * (Shown ONLY on the details page)
     *************************************/
    function buildCoverageForDetails({ residency, insurance }, location) {
      const lines = [];

      // general context
      if (residency === "local") {
        lines.push("Residency: In-province (QC). RAMQ often covers medically necessary physician/hospital services if you’re eligible.");
      } else if (residency === "out") {
        lines.push("Residency: Out-of-province. Your home provincial plan may reimburse care in Quebec; rules vary.");
      } else if (residency === "international") {
        lines.push("Residency: International. Coverage often depends on Blue Cross (if you’re enrolled) and what the provider accepts.");
      }

      if (!insurance.length || insurance.includes("none")) {
        lines.push("Insurance: None / not sure. Call the clinic/hospital and ask what documents and payment methods they accept. If you’re a student, check Minerva/your tuition invoice to confirm coverage.");
        return lines.join(" ");
      }

      const picked = [];
      if (insurance.includes("ramq")) picked.push("RAMQ");
      if (insurance.includes("other_prov")) picked.push("Other provincial/territorial");
      if (insurance.includes("bluecross")) picked.push("Blue Cross");
      if (insurance.includes("ssmu")) picked.push("SSMU/MCSS");

      lines.push(`Insurance selected: ${picked.join(", ")}.`);

      // location-type hints
      if (location.needs.includes("urgent")) {
        lines.push("Emergency departments generally provide care, but billing/eligibility can vary (especially if not RAMQ-covered). Bring ID/insurance documents if you have them.");
      } else {
        lines.push("For clinics, fees and coverage vary by provider and service type. Ask about the visit fee and whether they bill your insurer directly or require reimbursement.");
      }

      if (insurance.includes("ssmu")) {
        lines.push("SSMU/MCSS may help with eligible costs that aren’t fully covered elsewhere (example: certain prescriptions or services). Check plan details for exact reimbursement.");
      }

      return lines.join(" ");
    }

    /****************************************************
     * 2) MAKE "NONE / NOT SURE" MUTUALLY EXCLUSIVE
     ****************************************************/
    document.querySelectorAll('input[name="insurance"]').forEach((box) => {
      box.addEventListener("change", () => {
        const noneBox = document.querySelector('input[name="insurance"][value="none"]');
        const checkedBoxes = Array.from(document.querySelectorAll('input[name="insurance"]:checked'));

        if (box.value === "none" && box.checked) {
          checkedBoxes.forEach((cb) => { if (cb.value !== "none") cb.checked = false; });
        } else if (checkedBoxes.some((cb) => cb.value !== "none")) {
          noneBox.checked = false;
        }
      });
    });

    /*************************************
     * 3) MAP
     *************************************/
    let serviceMap = null;
    let serviceMarkers = [];
    const geocodeCache = new Map(); // address -> {lat, lng}

    function showMapUI() {
      document.getElementById("map-wrapper").style.display = "block";
    }
    function hideMapUI() {
      document.getElementById("map-wrapper").style.display = "none";
    }

    function initServiceMap() {
      if (serviceMap) return;

      serviceMap = L.map("service-map").setView([MCGILL_CENTER.lat, MCGILL_CENTER.lng], 13);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(serviceMap);

      const mcgillMarker = L.marker([MCGILL_CENTER.lat, MCGILL_CENTER.lng]).addTo(serviceMap);
      mcgillMarker.bindPopup(`<b>${MCGILL_CENTER.name}</b>`);
    }

    function clearMarkers() {
      serviceMarkers.forEach(m => m.remove());
      serviceMarkers = [];
    }

    async function geocodeAddress(address) {
      if (!address) return null;
      if (geocodeCache.has(address)) return geocodeCache.get(address);

      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;

      try {
        const resp = await fetch(url, { headers: { "Accept": "application/json" } });
        const data = await resp.json();
        if (!Array.isArray(data) || data.length === 0) return null;

        const result = { lat: Number(data[0].lat), lng: Number(data[0].lon) };
        if (Number.isFinite(result.lat) && Number.isFinite(result.lng)) {
          geocodeCache.set(address, result);
          return result;
        }
        return null;
      } catch (e) {
        return null;
      }
    }

    function getDirectionsUrl(lat, lng) {
      return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(lat + "," + lng)}`;
    }

    async function renderLocationsOnMap(matchingLocations, onClickLocation) {
      initServiceMap();
      clearMarkers();

      const resolved = [];
      for (const loc of matchingLocations) {
        let latLng = null;
        if (typeof loc.lat === "number" && typeof loc.lng === "number") {
          latLng = { lat: loc.lat, lng: loc.lng };
        } else {
          latLng = await geocodeAddress(loc.address);
        }
        resolved.push({ loc, latLng });
      }

      const boundsPoints = [[MCGILL_CENTER.lat, MCGILL_CENTER.lng]];
      for (const item of resolved) {
        if (!item.latLng) continue;

        boundsPoints.push([item.latLng.lat, item.latLng.lng]);

        const marker = L.marker([item.latLng.lat, item.latLng.lng]).addTo(serviceMap);
        marker.bindPopup(`<b>${item.loc.name}</b><br/><span class="muted">Click for details</span>`);
        marker.on("click", () => onClickLocation(item.loc, item.latLng));
        serviceMarkers.push(marker);
      }

      if (boundsPoints.length > 1) {
        serviceMap.fitBounds(boundsPoints, { padding: [30, 30] });
      } else {
        serviceMap.setView([MCGILL_CENTER.lat, MCGILL_CENTER.lng], 13);
      }

      return resolved;
    }

    /*************************************
     * 4) “PAGES” (VIEW SWITCHING)
     *************************************/
    const searchView = document.getElementById("search-view");
    const detailsView = document.getElementById("details-view");
    const detailsCard = document.getElementById("details-card");
    const breadcrumb = document.getElementById("details-breadcrumb");
    const backBtn = document.getElementById("back-btn");

    // Saved state from the form (so details knows what user picked)
    let lastUserSelections = null;
    let lastNeedLabel = "";
    let lastProblemLabel = "";

    function openDetailsPage(location, latLng) {
      if (!lastUserSelections) return;

      const directions = (latLng && latLng.lat && latLng.lng) ? getDirectionsUrl(latLng.lat, latLng.lng) : null;
      const coverageText = buildCoverageForDetails(lastUserSelections, location);

      const servicesHtml = (location.servicesOffered && location.servicesOffered.length)
        ? `<ul>${location.servicesOffered.map(s => `<li>${s}</li>`).join("")}</ul>`
        : `<p class="muted"><em>(Add “servicesOffered” for this location later.)</em></p>`;

      breadcrumb.textContent =
        lastNeedLabel + (lastProblemLabel ? ` → ${lastProblemLabel}` : "");

      detailsCard.innerHTML = `
        <h2 style="margin-top:0;">${location.name}</h2>

        ${location.address ? `<p><strong>Address:</strong> ${location.address}</p>` : ""}
        ${location.url ? `<p><strong>Website:</strong> <a href="${location.url}" target="_blank" rel="noopener noreferrer">${location.url}</a></p>` : ""}
        ${directions ? `<p><a href="${directions}" target="_blank" rel="noopener noreferrer">Get directions</a></p>` : ""}

        <hr style="border:none;border-top:1px solid #eee;margin:1rem 0;" />

        <h3>Services offered</h3>
        ${servicesHtml}

        <hr style="border:none;border-top:1px solid #eee;margin:1rem 0;" />

        <h3>Cost / coverage (based on your selections)</h3>
        <p>${coverageText}</p>
      `;

      // switch views
      searchView.style.display = "none";
      detailsView.style.display = "block";

      // optional: scroll to top
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function backToResults() {
      detailsView.style.display = "none";
      searchView.style.display = "block";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    backBtn.addEventListener("click", backToResults);

    /*************************************
     * 5) PROBLEM DROPDOWN
     *************************************/
    const needSelect = document.getElementById("need");
    const problemWrapper = document.getElementById("problem-wrapper");
    const problemSelect = document.getElementById("problem");

    function updateProblemDropdown() {
      const need = needSelect.value;

      if (problemOptions[need]) {
        problemWrapper.style.display = "block";
        problemSelect.innerHTML = "";
        problemOptions[need].forEach(p => {
          const opt = document.createElement("option");
          opt.value = p.value;
          opt.textContent = p.label;
          problemSelect.appendChild(opt);
        });
      } else {
        problemWrapper.style.display = "none";
        problemSelect.innerHTML = "";
      }
    }
    updateProblemDropdown();
    needSelect.addEventListener("change", updateProblemDropdown);

    /*************************************
     * 6) SUBMIT HANDLER
     * (IMPORTANT: We do NOT display insurance coverage here)
     *************************************/
    const form = document.getElementById("healthcare-form");
    const resultsDiv = document.getElementById("results");

    form.addEventListener("submit", async function (event) {
      event.preventDefault();

      const residency = document.getElementById("residency").value;
      const need = needSelect.value;

      const insurance = Array.from(
        document.querySelectorAll('input[name="insurance"]:checked')
      ).map((cb) => cb.value);

      // Save for the details page
      lastUserSelections = { residency, insurance };
      lastNeedLabel = needSelect.options[needSelect.selectedIndex].text;

      const problem = (problemWrapper.style.display !== "none") ? problemSelect.value : "";
      lastProblemLabel = (need === "general" && problemSelect.options.length)
        ? (problemSelect.options[problemSelect.selectedIndex]?.text || "")
        : "";

      // Filter resources for display (still ok to show these)
      const matchingResources = resources.filter(r => r.needs.includes(need));

      // Filter locations (problem filter only for general)
      const matchingLocations = locations.filter(l => {
        if (!l.needs.includes(need)) return false;

        if (need === "general") {
          if (!problem) return true;
          if (!l.problems) return true;
          return l.problems.includes(problem);
        }
        return true;
      });

      // Build results HTML (no coverage text here)
      let html = `<h2>Results</h2>`;
      html += `<p class="muted">Click a resource or location to see details.</p>`;

      if (need === "general" && problem) {
        html += `<p><strong>Selected category:</strong> ${lastProblemLabel}</p>`;
      }

      if (need === "urgent") {
        html += `
          <div class="card">
            <h3>Emergency note</h3>
            <p>If you are in immediate danger or experiencing a medical emergency, call 911 or go to the nearest emergency department.</p>
          </div>
        `;
      }

      // Resources
      if (matchingResources.length) {
        html += `<h3>Resources</h3>`;
        matchingResources.forEach((r) => {
          html += `
            <div class="card">
              <h3>${r.name}</h3>
              <p>${r.description || ""}</p>
              ${r.url ? `<p><a href="${r.url}" target="_blank" rel="noopener noreferrer">Learn more</a></p>` : ""}
            </div>
          `;
        });
      }

      // Locations
      html += `<h3>Locations</h3>`;
      if (!matchingLocations.length) {
        html += `<p>No locations found for that selection.</p>`;
        resultsDiv.innerHTML = html;
        hideMapUI();
        return;
      }

      // Show loading while geocoding + rendering pins
      resultsDiv.innerHTML = html + `<p class="muted">Loading map and locations…</p>`;
      showMapUI();
      initServiceMap();

      // Render map pins + keep resolved coords so cards can open details with directions
      const resolved = await renderLocationsOnMap(matchingLocations, (loc, latLng) => {
        openDetailsPage(loc, latLng);
      });

      let locationsHtml = "";
      resolved.forEach(({ loc, latLng }) => {
        const hasCoords = !!latLng;
        const coordsNote = hasCoords ? "" : `<p class="muted"><em>(Pin not available yet — update the address or add coordinates.)</em></p>`;

        locationsHtml += `
          <div class="card clickable" data-loc-id="${loc.id}">
            <h3>${loc.name}</h3>
            <p>${loc.address || ""}</p>
            ${coordsNote}
            <p class="muted"><em>Click to view details (website, services, coverage).</em></p>
          </div>
        `;
      });

      resultsDiv.innerHTML = html + locationsHtml;

      // Clicking a card opens the details “page”
      document.querySelectorAll('[data-loc-id]').forEach(card => {
        card.addEventListener("click", () => {
          const id = card.getAttribute("data-loc-id");
          const item = resolved.find(x => x.loc.id === id);
          if (!item) return;
          openDetailsPage(item.loc, item.latLng);
        });
      });
    });
  </script>
</body>
</html>
